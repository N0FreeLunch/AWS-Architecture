
## 문제
- 매년 2.3배의 서비스 규모 증가 => 마이크로 서비스로 가야 한다.


## 마이크로 서비스란?
- 서버만 독립적인 것이 아닌 데이터베이스까지 분리되는 서비스
- 전체 트레픽 부하를 줄이고 하나의 시스템이 터져도 다른 시스템은 돌아갈 수 있도록 운영한다.

## 
- 게이트웨이 서비스를 nodejs를 사용 (나중에는 자바로 변경)


## 선착순 결제 할인
- 갑작스런 대용량 트레픽으로 대응하기 어려움
- 프론트 서버 -> 주문 -> 결제
1. 프론트 서버 뻗음
- 프론트 서버 해결 : IDC -> 스케일이 자유로운 AWS로 바꿔 갑작스런 대용량 트레픽을 받을 수 있도록 함
2. 주문 서버 IDC가 뻗음
- 주문서버 IDC 장비를 늘림
3. 결제사 장애


## 장애
- 쿠폰 포인트 MSSQL => AWS로 이동
- 가게 상세화면 => 여러 데이터가 종합적으로 불러와 져 과부하
- 오프라인 모드 (AWS 서비스가 죽었을 때 오프라인 모드로 큰 역할을 함)

### 가게 상세, 가게 목록
- 루비 디비에 들어오던 트레픽을 다이나모 디비에 분산처리 함. Ruby DB 쪽으로 들어오는 데이터는 모아서 배치로 1~5분 주기로 전송 => 루비 DB의 트레픽을 줄임
- 1~5분 정도 싱크가 느려짐
- 비즈니스 로직이 바뀌면 쿼리 수정이 너무 많아짐

### 주문
- 결제, 포인트, 정산, 메뉴 등등 가장 복잡한 시스템
- 하루 100만 데이터가 쌓임
기존
- 배민 주문 로직 -> 루비디비 -> 배민 테이블
- 라이더스 주문로직 -> 루비디비 -> 라이더스 테이블
리펙토링
- 배민 주문 + 라이더스를 하나의 도메인에 묶음 -> AWS Aroura

주문의 라이프 사이클이 복잡
- 외부 API를 너무 많이 호출 하게 됨
- 리뷰 시스템은 주문이 완료 되었다는 것을 알아야 함
- 주문 시스템의 API가 끊기면 다른 서비스가 끊김 => 이벤트 기반의 서비스로 만듦
- 주문 시스템은 이벤트만 발행(생성, 접수, 배달완료, 취소)하므로 각각의 서비스가 이벤트를 가져다가 처리하라
- AWS-SQS에 도메인별로 주문 이벤트들을 넣고 각각의 도메인별 SQS에서 리뷰 시스템에서 큐를 가져다 쓰고, 레거시 DB와 싱크 맞추는데 큐를 가져다 쓰고, 라이더스 시스템에서 큐를 가져다 쓰는 방식으로 설계
- 이벤트 기반으로 바꾼 후 추가적인 장점 => 주문 시스템의 API가 뻑나면 이벤트가 다 사라져 있지만, 이벤트 기반의 경우 AWS-SQS에 처리 되지 않은 큐는 남아 있어서 잠시 멈춰도 안정적인 서비스가 된다.
- 이렇게 주문 이벤트만 발행하면 주문 시스템에서는 연동 작업을 할 일이 없고 다른 시스템에서 가져다 쓰면 된다.

### 가게/업주
- 가게 업주와 광고 => 역사가 오래 되었다.
- 가게 하나에는 하나의 광고만 존재하는 레거시 시스템 => 가게 테이블 안에 광고 데이터가 들어가 있다. 컬럼 100개
- 광고를 손대기 => 가게에 영향, 가게에 손대기 => 광고에 영향. 시스템을 멈추지 않고는 안 된다.
- 루비 디비의 게게 데이터, 광고 데이터를 가게상세, 가게 목록/검색, 프론트 서버, 사장님 사이트, 전체 어드민 모두가 접속해서 데이터를 꺼내가는 형식으로 되어 있다.
- 루비 디비를 건드리면 모든 시스템이 다 문제 생긴다.
- 서비스 조회용 가게 목록을 가져 오는 쿼리 모델을 만듦
- 가게 목록, 시스템
- 광고 도메인과 가게/업주 도메인을 분리하여 모델을 만들어서 필요한 게 있으면 광고 모델에 접근하고, 가게/업주 모델에 접근 
- 만약 광고 시스템이 멈춘다면 광고 시스템을 사용하고 있는 모든 시스템이 연쇄적으로 장애를 겪음, 가게 시스템이 멈추면 가게 시스템을 사용하고 있는 모든 시스템이 연쇄적으로 멈춤
- 대용량 트레픽이 갑작스럽게 들어 올 경우를 대비 (대용량 트레픽을 대비할 수 있도록 대용량 트레픽을 처리할 수 있는 용량 증가는 현실적인 방안이 아님)


성능
- 대용량 트레픽 대비
- 메인, 가게 리스트, 가게 상세 API는 초당 15000회 호출
- 모든 시스템이 대용량 트레픽을 감당하기는 어려움

장애 격리
- 가게, 광고 같은 내부 서비스나 DB에 장애가 발생해도 고객 서비스를 유지하고 주문도 가능해야 함
- 고객 서비스를 유지하고 주문도 가능해야 함. 

데이터 동기화


해결 방안
- CQRS 시스템으로 바꿈.
- 핵심 비즈니스 명령 시스템과 조회 중심의 사용자 서비스를 철저하게 분리
- 조회 : 광고 리스팅, 가게 노출, 바로 결제 라이브, 검색
- 검색 : 광고, 가게/업주

사장이 가게


### 광고
- 프로시저 사용 1위
- 돈을 다루는 영역




---

Reference : https://youtu.be/BnS6343GTkY
[우아콘2020] 배달의 민족 마이크로서비스 여행기
